<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.oopssinsa.model.dao.ObMapper">

    <resultMap id="obRequestMap" type="ObRequestDto">
        <id column="id" property="id"/>
        <id column="product_id" property="productId"/>
        <result column="login_id" property="loginId"/>
        <result column="quantity" property="quantity"/>
        <result column="recipient_name" property="recipientName"/>
        <result column="address" property="address"/>
        <result column="ob_date" property="obDate"/>
    </resultMap>

    <resultMap id="obDetailMap" type="com.oopssinsa.model.dto.ob.ObDetailDto">
        <id column="manufacture_date" property="manufactureDate"/>
        <id column="product_id" property="productId"/>
        <id column="ob_id" property="obId"/>
        <result column="quantity" property="quantity"/>
        <result column="status" property="status"/>
        <result column="completion_date" property="completionDate"/>
        <result column="tracking_number" property="trackingNumber"/>
        <result column="ob_date" property="obDate"/>
    </resultMap>

    <resultMap id="obDtoMap" type="com.oopssinsa.model.dto.ob.ObDto">
        <result column="manufacture_date" property="manufactureDate"/>
        <result column="ob_id" property="obId"/>
        <result column="product_id" property="productId"/>
        <result column="quantity" property="quantity"/>
        <result column="status" property="status"/>
        <result column="completion_date" property="completionDate"/>
        <result column="tracking_number" property="trackingNumber"/>
        <result column="login_id" property="loginId"/>
        <result column="recipient_name" property="recipientName"/>
        <result column="address" property="address"/>
        <result column="ob_date" property="obDate"/>
    </resultMap>


    <!-- 모든 OB 요청 상태 조회 -->
    <select id="findObByRequestState" resultMap="obRequestMap">
        SELECT * FROM ob_request
    </select>

    <!-- 모든 OB 상세 조회 -->
<!--    <select id="findAllOb" resultMap="obDetailMap">-->
<!--        SELECT-->
<!--        od.*, obr.ob_date-->
<!--        FROM ob_detail od left join ob_request obr on (od.ob_id = obr.id and od.product_id = obr.product_id)-->
<!--    </select>-->
    <select id="findAllOb" resultMap="obDtoMap">
        SELECT
        od.manufacture_date as manufacture_date,
        od.ob_id as ob_id,
        od.product_id as product_id,
        obr.login_id as login_id,
        obr.recipient_name as recipient_name,
        obr.address as address,
        od.quantity as quantity,
        od.status as status,
        obr.ob_date as ob_date
        od.completion_date as completion_date,
        od.tracking_number as tracking_number
        FROM ob_detail od left join ob_request obr on (od.ob_id = obr.id and od.product_id = obr.product_id)
    </select>

    <!-- 모든 재고 조회 -->
    <select id="findAllStock" resultType="com.oopssinsa.model.dto.StockDto">
        SELECT * FROM stock
    </select>

    <!-- 특정 제품 ID에 따른 주문 가능 재고 조회 -->
    <select id="findStockOrderableByProductId" parameterType="string" resultType="com.oopssinsa.model.dto.StockDto">
        SELECT * FROM stock WHERE product_id = #{productId} AND quantity > 0
    </select>

    <!-- OB 요청과 재고 정보 조회 -->
    <select id="findObRequestAndStock" resultType="com.oopssinsa.model.dto.ob.ObRequestAndStockDto">
        SELECT *
        FROM ob_request ob
        JOIN stock st
        ON ob.product_id = st.product_id
    </select>

    <!-- 재고 업데이트 -->
    <update id="updateStock" parameterType="com.oopssinsa.model.dto.StockDto">
        UPDATE stock SET quantity = #{quantity} WHERE id = #{id}
    </update>

    <!-- OB 상세 정보 삽입 -->
    <insert id="insertObDetails" parameterType="list">
        INSERT INTO ob_detail (manufacture_date, ob_id, product_id, quantity, status, completion_date, tracking_number) VALUES
        <foreach collection="list" item="detail" separator=",">
            (#{detail.manufactureDate}, #{detail.obId}, #{detail.productId}, #{detail.quantity}, #{detail.status}, #{detail.completionDate}, #{detail.trackingNumber})
        </foreach>
    </insert>

    <!-- OB 상태 업데이트 -->
    <update id="updateObState" parameterType="com.oopssinsa.model.dto.ob.ObDetailDto">
        UPDATE ob_detail SET status = #{status} WHERE id = #{id}
    </update>

    <!-- 대기 상태의 OB 상세 정보 조회 -->
    <select id="findObDetailByWaitingState" resultType="com.oopssinsa.model.dto.ob.ObDetailDto">
        SELECT * FROM ob_detail WHERE status = 'W'
    </select>

    <!-- OB 작업자 삽입 -->
    <insert id="insertObWorker" parameterType="com.oopssinsa.model.dto.InstructionDto">
        INSERT INTO ob_worker (manufacture_date, ob_id, product_id, worker_id, location_id) VALUES
        (#{manufactureDate}, #{obId}, #{productId}, #{workerId}, #{locationId})
    </insert>

</mapper>